<div id="mensaje-permiso" style="position:fixed; top:0; left:0; width:100%; height:100%; 
    background-color:rgba(0,0,0,0.7); color:white; display:flex; flex-direction:column; 
    justify-content:center; align-items:center; font-size:18px; z-index:1000;">
    <div style="padding:20px; text-align:center;">
        <p>Para usar la app de reconocimiento de voz, necesitamos tu permiso para acceder al micrófono.</p>
        <button id="boton-permiso" style="padding:10px 20px; font-size:16px;">Aceptar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
const URL = "https://teachablemachine.withgoogle.com/models/OCmF1CcyK/";
let recognizer = null;
let listening = false;

// Mostrar mensaje personalizado y pedir permiso al pulsar el botón
document.getElementById("boton-permiso").addEventListener("click", async () => {
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("Permiso de micrófono concedido");
        // Ocultar mensaje
        document.getElementById("mensaje-permiso").style.display = "none";
    } catch (err) {
        console.log("Permiso de micrófono denegado", err);
        alert("No podrás usar la app sin permitir el micrófono.");
    }
});

async function createModel() {
    if (!recognizer) {
        const checkpointURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        recognizer = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            checkpointURL,
            metadataURL
        );

        await recognizer.ensureModelLoaded();
    }
    return recognizer;
}

async function startListening() {
    await createModel();
    if (listening) return;

    listening = true;

    recognizer.listen(result => {
        if (!listening) return;

        const scores = result.scores;
        let maxScore = 0;
        let detectedClass = "";
        const labels = recognizer.wordLabels();

        for (let i = 0; i < labels.length; i++) {
            if (scores[i] > maxScore) {
                maxScore = scores[i];
                detectedClass = labels[i];
            }
        }

        // Sensibilidad más alta: probabilidad mínima 0.4
        if (maxScore > 0.4) {
            window.AppInventor.setWebViewString(detectedClass);
        }
    }, {
        includeSpectrogram: false,
        probabilityThreshold: 0.4,
        invokeCallbackOnNoiseAndUnknown: true,
        overlapFactor: 0.5
    });
}

function stopListening() {
    listening = false;
    if (recognizer) recognizer.stopListening();
}
</script>
