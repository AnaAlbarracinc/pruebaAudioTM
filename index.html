<div style="display:none;">Teachable Machine Audio Model</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
const URL = "https://teachablemachine.withgoogle.com/models/OCmF1CcyK/";
let recognizer = null;
let listening = false;

// Pedir permiso de micrófono al cargar la página
window.addEventListener("load", async () => {
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("Permiso de micrófono concedido");
    } catch (err) {
        console.log("Permiso de micrófono denegado", err);
        alert("Necesitas permitir el micrófono para usar la app.");
    }
});

async function createModel() {
    if (!recognizer) {
        const checkpointURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        recognizer = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            checkpointURL,
            metadataURL
        );

        await recognizer.ensureModelLoaded();
    }
    return recognizer;
}

async function startListening() {
    await createModel();
    if (listening) return;

    listening = true;

    recognizer.listen(result => {
        if (!listening) return;

        const scores = result.scores;
        let maxScore = 0;
        let detectedClass = "";
        const labels = recognizer.wordLabels();

        for (let i = 0; i < labels.length; i++) {
            if (scores[i] > maxScore) {
                maxScore = scores[i];
                detectedClass = labels[i];
            }
        }

        // Sensibilidad más alta: probabilidad mínima 0.4
        if (maxScore > 0.4) {
            window.AppInventor.setWebViewString(detectedClass);
        }
    }, {
        includeSpectrogram: false,
        probabilityThreshold: 0.4,
        invokeCallbackOnNoiseAndUnknown: true,
        overlapFactor: 0.5
    });
}

function stopListening() {
    listening = false;
    if (recognizer) recognizer.stopListening();
}
</script>
